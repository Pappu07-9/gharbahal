<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body class="bg-blue-100 font-sans">
    <nav class="bg-gradient-to-r from-green-300 to-green-800 p-5">
        <div class="container mx-5 flex justify-between items-center">
            <a href="/" class="text-black mr-6 disabled">Welcome to <strong class="text-2xl">GharBahal.com</strong></a>
            <div class="flex">
                <input type="text" placeholder="Search.."
                    class="px-4 py-2 rounded-l ml-2 bg-green-200 w-[800px] border border-green-400">

                <button type="submit"
                    class="px-4 py-2 bg-green-500 text-white rounded-r hover:bg-green-600">Search</button>
            </div>
            <div id="auth-links" class="flex space-x-4 mr-6">
                <!-- Auth links will be injected here by JavaScript -->
            </div>
        </div>
    </nav>

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 p-4" id="sidebar">
            <ul class="space-y-4">
                <li>
                    <a href="/add-product" class="block text-black hover:bg-green-500 hover:text-white rounded p-3">Add
                        Product</a>
                </li>
                <li>
                    <a href="/profile" class="block text-black hover:bg-green-500 hover:text-white rounded p-3">My
                        Profile</a>
                </li>
            </ul>
        </aside>

        <!-- Main content -->
        <div class="flex-1 p-4">
            <div class="container mx-auto mt-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Products Dashboard</h2>
                <div class="flex flex-wrap justify-center gap-2" id="products-grid">
                    <!-- Products will be injected here by JavaScript -->
                </div>
                <div class="flex justify-center mt-4 mb-4" id="pagination-controls">
                    <!-- Pagination controls will be injected here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () { checkToken(); });
        function handlesuccess(res) {
            const authLinks = document.getElementById("auth-links")
            const sidebar = document.getElementById("sidebar")
            console.log(res)
            const { success, data, message } = res
            if (success) {
                console.log(data)
                authLinks.innerHTML = `
                    <p class="text-black px-3 py-2 rounded">Welcome, ${data.username}</p>
                    <a href="/logout" id="logout" class="text-black hover:bg-green-900 hover:text-white px-3 py-2 rounded">Logout</a>
                `;
                sidebar.innerHTML = `
                    <ul class="space-y-4">
                <li>
                    <a href="/add-product" class="block text-black hover:bg-green-500 hover:text-white rounded p-3">Add
                        Product</a>
                </li>
                <li>
                    <a href="/profile" class="block text-black hover:bg-green-500 hover:text-white rounded p-3">My
                        Profile</a>
                </li>
            </ul>
                `;

                document.getElementById('logout').addEventListener('click', function (e) {
                    e.preventDefault();
                    localStorage.removeItem("Authorization");
                    checkToken(); // Refresh the auth links to show login/register
                });
            } else {
                authLinks.innerHTML = `
                    <a href="login" class="text-black hover:bg-black hover:text-white px-3 py-2 rounded">Login</a>
                    <a href="register" class="text-black hover:bg-black hover:text-white px-3 py-2 rounded">Register</a>
                `;
                sidebar.style.display = "none";
            }
        }

        async function checkToken() {
            const token = JSON.parse(localStorage.getItem("Authorization"))
            try {
                const response = await fetch("/api/checktoken", {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const res = await response.json();
                handlesuccess(res);
            } catch (error) {
                console.log("Error", error);
                alert("Server Error");
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            let currentPage = 1;
            const pageSize = 6;
            const propertiesGrid = document.getElementById('products-grid');
            const paginationControls = document.getElementById('pagination-controls');

            function fetchProperties(page = 1) {
                fetch(`/api/properties?page=${page}&page_size=${pageSize}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Response data:', data);
                        if (!data.properties) {
                            throw new Error('Invalid response structure');
                        }

                        propertiesGrid.innerHTML = '';
                        data.properties.forEach(property => {
                            const propertyElement = document.createElement('div');
                            propertyElement.classList.add('bg-white', "group", "hover:text-white", "hover:bg-green-500", 'p-5', 'rounded-lg', 'shadow-md', 'w-[10rem]', 'md:w-1/2', 'lg:w-[20rem]');

                            propertyElement.innerHTML = `
                                <h3 class="text-xl font-semibold mb-2 group-hover:text-white">${property.title}</h3>
                                <p class="text-gray-700 mb-4 group-hover:text-white">${property.description}</p>
                                <p class="text-gray-600 mb-2 group-hover:text-white">${property.address}, ${property.city}, ${property.state}, ${property.zip_code}</p>
                                <div class="text-lg font-bold group-hover:text-white text-green-500">$${property.price}</div>
                            `;

                            propertiesGrid.appendChild(propertyElement);
                        });

                        // Update pagination controls
                        const totalPages = Math.ceil(data.total_count / pageSize);
                        let paginationHtml = '';

                        paginationHtml += `<button class="page-btn border bg-white-500 text-black border-green-500 hover:bg-green-500 hover:text-white rounded mx-3 my-3 p-3" ${page === 1 ? 'disabled' : ''} onclick="changePage(${page - 1})">Prev</button>`;

                        for (let i = 1; i <= totalPages; i++) {
                            if (i === page) {
                                paginationHtml += `<button class="page-btn border bg-white-500 text-black border-green-500 hover:bg-green-500 hover:text-white rounded active mx-3 my-3 p-3" onclick="changePage(${i})">${i}</button>`;
                            } else {
                                paginationHtml += `<button class="page-btn border bg-white-500 text-black border-green-500 hover:bg-green-500 hover:text-white rounded mx-3 my-3 p-3" onclick="changePage(${i})">${i}</button>`;
                            }
                        }

                        paginationHtml += `<button class="page-btn border bg-white-500 text-black border-green-500 hover:bg-green-500 hover:text-white rounded mx-3 my-3 p-3" ${page === totalPages ? 'disabled' : ''} onclick="changePage(${page + 1})">Next</button>`;

                        paginationControls.innerHTML = paginationHtml;
                    })
                    .catch(error => console.error('Error fetching properties:', error));
            }

            window.changePage = function (page) {
                currentPage = page;
                fetchProperties(page);
            }

            fetchProperties(currentPage);
        });
    </script>
</body>

</html>